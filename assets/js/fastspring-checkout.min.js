var checkoutForm = jQuery('form.checkout'); function setLoadingDone () { checkoutForm.removeClass('processing').unblock() } function setLoadingOn () { checkoutForm.addClass('processing').block({message: null, overlayCSS: {background: '#fff', opacity: 0.6}}) } function getAjaxURL (e) { return woocommerce_fastspring_params.ajax_url.toString().replace('%%endpoint%%', 'wc_fastspring_' + e) } function fastspringBeforeRequestHandler () { setLoadingDone() } function fastspringPopupCloseHandler (e) { e && e.reference && requestPaymentCompletionUrl(e || {}, function (e, o) { e || (window.location = o.redirect_url) }) } function requestPaymentCompletionUrl (e, o) { e.security = woocommerce_fastspring_params.nonce.receipt, jQuery.ajax({type: 'POST', dataType: 'json', data: JSON.stringify(e), url: getAjaxURL('get_receipt'), success: function (e) { o(null, e) }, error: function (e, r, t) { o(e.responseText) }}) } function launchFastSpring (e) { fastspring.builder.secure(e.payload, e.key), fastspring.builder.checkout() } function setOrder (e) { jQuery.ajax({type: 'POST', url: wc_checkout_params.checkout_url, data: checkoutForm.serialize(), dataType: 'json', success: function (o) { try { if (o.result !== 'success') throw o.result === 'failure' ? new Error('Result failure') : new Error('Invalid response'); e(null, o) } catch (e) { if (!0 === o.reload) return void window.location.reload(); !0 === o.refresh && jQuery(document.body).trigger('update_checkout'), o.messages ? submitError(o.messages) : submitError('<div class="woocommerce-error">' + wc_checkout_params.i18n_checkout_error + '</div>') } }, error: function (e, o, r) { submitError('<div class="woocommerce-error">' + r + '</div>') }}) } function doSubmit () { setLoadingOn(), setOrder(function (e, o) { e || launchFastSpring(o.session) }) } function submitError (e) { setLoadingDone(), jQuery('.woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message').remove(), checkoutForm.prepend('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-checkout">' + e + '</div>'), checkoutForm.removeClass('processing'), checkoutForm.find('.input-text, select, input:checkbox').trigger('validate').blur(), jQuery('html, body').animate({scrollTop: jQuery('form.checkout').offset().top - 100}, 1e3), jQuery(document.body).trigger('checkout_error') } function isFastSpringSelected () { return jQuery('.woocommerce-checkout input[name="payment_method"]:checked').attr('id') === 'payment_method_fastspring' }checkoutForm.on('checkout_place_order', function () { if (isFastSpringSelected()) return doSubmit(), !1 })
